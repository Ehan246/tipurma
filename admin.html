<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অ্যাডমিন প্যানেল - ItemsalesBD</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script type="module" src="firebase-config.js"></script>
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #2563eb;
            margin-top: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .orders-table th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-size: 14px;
            color: #666;
        }
        
        .orders-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background: #d4edda;
            color: #155724;
        }
        
        .select-status {
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- অ্যাডমিন হেডার -->
        <div class="admin-header" style="margin-top: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 class="admin-title">
                        <i class="fas fa-shield-alt" style="color: #2563eb;"></i>
                        অ্যাডমিন প্যানেল - ItemsalesBD
                    </h1>
                    <p style="color: #666; margin-top: 10px;">প্রোডাক্ট ও অর্ডার ম্যানেজ করুন</p>
                </div>
                <button id="logoutBtn" class="btn btn-outline">
                    <i class="fas fa-sign-out-alt"></i> লগআউট
                </button>
            </div>
        </div>
        
        <!-- অ্যাডমিন চেক -->
        <div id="adminContent" style="display: none;">
            <!-- স্ট্যাটস কার্ড -->
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-box" style="color: #2563eb; font-size: 24px;"></i>
                    <div class="stat-number" id="totalProducts">0</div>
                    <div class="stat-label">মোট প্রোডাক্ট</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-shopping-cart" style="color: #f59e0b; font-size: 24px;"></i>
                    <div class="stat-number" id="totalOrders">0</div>
                    <div class="stat-label">মোট অর্ডার</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock" style="color: #f97316; font-size: 24px;"></i>
                    <div class="stat-number" id="pendingOrders">0</div>
                    <div class="stat-label">পেন্ডিং অর্ডার</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle" style="color: #10b981; font-size: 24px;"></i>
                    <div class="stat-number" id="completedOrders">0</div>
                    <div class="stat-label">কমপ্লিট অর্ডার</div>
                </div>
            </div>
            
            <!-- প্রোডাক্ট এড করার ফর্ম -->
            <div class="admin-card">
                <h3><i class="fas fa-plus-circle" style="color: #2563eb;"></i> নতুন প্রোডাক্ট যোগ করুন</h3>
                
                <div id="productAlert" style="display: none;"></div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label>প্রোডাক্টের নাম</label>
                        <input type="text" id="productName" class="form-control" placeholder="যেমন: স্মার্টফোন">
                    </div>
                    
                    <div class="form-group">
                        <label>দাম (৳)</label>
                        <input type="number" id="productPrice" class="form-control" placeholder="০.০০">
                    </div>
                    
                    <div class="form-group">
                        <label>স্টক পরিমাণ</label>
                        <input type="number" id="productStock" class="form-control" placeholder="১০">
                    </div>
                    
                    <div style="display: flex; align-items: flex-end;">
                        <button onclick="addProduct()" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-save"></i> প্রোডাক্ট যোগ করুন
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- প্রোডাক্ট লিস্ট -->
            <div class="admin-card">
                <h3><i class="fas fa-list" style="color: #2563eb;"></i> সব প্রোডাক্ট</h3>
                <div id="productList" class="product-list">
                    <!-- প্রোডাক্ট লিস্ট ডাইনামিক লোড হবে -->
                </div>
            </div>
            
            <!-- অর্ডার লিস্ট -->
            <div class="admin-card">
                <h3><i class="fas fa-truck" style="color: #2563eb;"></i> অর্ডার লিস্ট</h3>
                <div id="ordersList">
                    <!-- অর্ডার ডাইনামিক লোড হবে -->
                </div>
            </div>
        </div>
        
        <!-- এক্সেস ডিনাইড -->
        <div id="accessDenied" style="display: none; text-align: center; padding: 60px;">
            <i class="fas fa-shield-alt" style="font-size: 80px; color: #dc2626;"></i>
            <h2 style="margin-top: 20px; color: #333;">অ্যাক্সেস ডিনাইড!</h2>
            <p style="color: #666; margin-top: 10px;">শুধুমাত্র অ্যাডমিন এই পৃষ্ঠা দেখতে পারেন।</p>
            <a href="index.html" class="btn btn-primary" style="margin-top: 20px;">
                <i class="fas fa-home"></i> হোম পেজে যান
            </a>
        </div>
    </div>

    <script type="module">
        import { 
            auth, db, 
            onAuthStateChanged, 
            signOut,
            ref, push, set, update, remove, onValue, get 
        } from './firebase-config.js';

        let isAdmin = false;

        // অ্যাডমিন চেক
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const adminSnap = await get(ref(db, 'users/' + user.uid + '/role'));
                isAdmin = adminSnap.val() === 'admin';
                
                if (isAdmin) {
                    document.getElementById('adminContent').style.display = 'block';
                    document.getElementById('accessDenied').style.display = 'none';
                    loadProducts();
                    loadOrders();
                    loadStats();
                } else {
                    document.getElementById('adminContent').style.display = 'none';
                    document.getElementById('accessDenied').style.display = 'block';
                }
            } catch (error) {
                console.error(error);
            }
        });

        // লগআউট
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'index.html';
        });

        // প্রোডাক্ট যোগ করার ফাংশন
        window.addProduct = async function() {
            const name = document.getElementById('productName').value;
            const price = document.getElementById('productPrice').value;
            const stock = document.getElementById('productStock').value;
            const alertDiv = document.getElementById('productAlert');
            
            if (!name || !price || !stock) {
                alertDiv.style.display = 'block';
                alertDiv.className = 'alert alert-error';
                alertDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> সব ফিল্ড পূরণ করুন!';
                return;
            }
            
            try {
                await push(ref(db, 'products'), {
                    name: name,
                    price: Number(price),
                    stock: Number(stock),
                    createdAt: Date.now()
                });
                
                alertDiv.style.display = 'block';
                alertDiv.className = 'alert alert-success';
                alertDiv.innerHTML = '<i class="fas fa-check-circle"></i> প্রোডাক্ট যোগ হয়েছে!';
                
                // ফর্ম ক্লিয়ার
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productStock').value = '';
                
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 3000);
                
            } catch (error) {
                alertDiv.style.display = 'block';
                alertDiv.className = 'alert alert-error';
                alertDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> প্রোডাক্ট যোগ ব্যর্থ!';
            }
        };

        // প্রোডাক্ট লোড
        function loadProducts() {
            const productsRef = ref(db, 'products');
            
            onValue(productsRef, (snapshot) => {
                const products = snapshot.val() || {};
                const productList = document.getElementById('productList');
                
                if (Object.keys(products).length === 0) {
                    productList.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">কোন প্রোডাক্ট নেই। নতুন প্রোডাক্ট যোগ করুন।</p>';
                    return;
                }
                
                let html = '';
                
                Object.keys(products).forEach(key => {
                    const p = products[key];
                    html += `
                        <div class="product-item">
                            <div class="product-info">
                                <h4>${p.name}</h4>
                                <p>দাম: ৳${p.price} | স্টক: ${p.stock} টি</p>
                            </div>
                            <div class="admin-actions">
                                <button class="btn-sm btn-edit" onclick="editProduct('${key}', '${p.name}', ${p.price}, ${p.stock})">
                                    <i class="fas fa-edit"></i> এডিট
                                </button>
                                <button class="btn-sm btn-delete" onclick="deleteProduct('${key}')">
                                    <i class="fas fa-trash"></i> ডিলিট
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                productList.innerHTML = html;
            });
        }

        // প্রোডাক্ট এডিট
        window.editProduct = async function(id, oldName, oldPrice, oldStock) {
            const newName = prompt('প্রোডাক্টের নতুন নাম:', oldName);
            if (newName === null) return;
            
            const newPrice = prompt('প্রোডাক্টের নতুন দাম (৳):', oldPrice);
            if (newPrice === null) return;
            
            const newStock = prompt('প্রোডাক্টের নতুন স্টক:', oldStock);
            if (newStock === null) return;
            
            try {
                await update(ref(db, 'products/' + id), {
                    name: newName,
                    price: Number(newPrice),
                    stock: Number(newStock),
                    updatedAt: Date.now()
                });
                alert('✅ প্রোডাক্ট আপডেট হয়েছে!');
            } catch (error) {
                alert('❌ আপডেট ব্যর্থ!');
            }
        };

        // প্রোডাক্ট ডিলিট
        window.deleteProduct = async function(id) {
            if (confirm('আপনি কি নিশ্চিত? এই প্রোডাক্ট ডিলিট হবে!')) {
                try {
                    await remove(ref(db, 'products/' + id));
                    alert('✅ প্রোডাক্ট ডিলিট হয়েছে!');
                } catch (error) {
                    alert('❌ ডিলিট ব্যর্থ!');
                }
            }
        };

        // অর্ডার লোড
        function loadOrders() {
            const ordersRef = ref(db, 'orders');
            
            onValue(ordersRef, (snapshot) => {
                const orders = snapshot.val() || {};
                const ordersList = document.getElementById('ordersList');
                
                if (Object.keys(orders).length === 0) {
                    ordersList.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">কোন অর্ডার নেই।</p>';
                    return;
                }
                
                let html = `
                    <table class="orders-table">
                        <thead>
                            <tr>
                                <th>তারিখ</th>
                                <th>প্রোডাক্ট</th>
                                <th>ক্রেতা</th>
                                <th>দাম</th>
                                <th>স্ট্যাটাস</th>
                                <th>অ্যাকশন</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                Object.keys(orders).reverse().forEach(key => {
                    const order = orders[key];
                    const date = new Date(order.orderDate || order.createdAt || Date.now()).toLocaleDateString('bn-BD');
                    
                    html += `
                        <tr>
                            <td>${date}</td>
                            <td>${order.productName || order.productId}</td>
                            <td>${order.buyerEmail || 'ক্রেতা'}</td>
                            <td>৳${order.price}</td>
                            <td>
                                <span class="status-badge status-${order.status || 'pending'}">
                                    ${order.status === 'completed' ? 'কমপ্লিট' : 'পেন্ডিং'}
                                </span>
                            </td>
                            <td>
                                <select class="select-status" onchange="updateOrderStatus('${key}', this.value)">
                                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>পেন্ডিং</option>
                                    <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>প্রসেসিং</option>
                                    <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>কমপ্লিট</option>
                                </select>
                                <button onclick="deleteOrder('${key}')" style="margin-left: 10px; color: #dc2626; background: none; border: none; cursor: pointer;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                ordersList.innerHTML = html;
            });
        }

        // অর্ডার স্ট্যাটাস আপডেট
        window.updateOrderStatus = async function(orderId, status) {
            try {
                await update(ref(db, 'orders/' + orderId), { status: status });
                alert('✅ অর্ডার স্ট্যাটাস আপডেট হয়েছে!');
            } catch (error) {
                alert('❌ আপডেট ব্যর্থ!');
            }
        };

        // অর্ডার ডিলিট
        window.deleteOrder = async function(orderId) {
            if (confirm('অর্ডারটি ডিলিট করবেন?')) {
                try {
                    await remove(ref(db, 'orders/' + orderId));
                    alert('✅ অর্ডার ডিলিট হয়েছে!');
                } catch (error) {
                    alert('❌ ডিলিট ব্যর্থ!');
                }
            }
        };

        // স্ট্যাটস লোড
        function loadStats() {
            const productsRef = ref(db, 'products');
            const ordersRef = ref(db, 'orders');
            
            onValue(productsRef, (snapshot) => {
                document.getElementById('totalProducts').textContent = snapshot.size || 0;
            });
            
            onValue(ordersRef, (snapshot) => {
                const orders = snapshot.val() || {};
                const total = Object.keys(orders).length;
                const pending = Object.values(orders).filter(o => o.status === 'pending' || !o.status).length;
                const completed = Object.values(orders).filter(o => o.status === 'completed').length;
                
                document.getElementById('totalOrders').textContent = total;
                document.getElementById('pendingOrders').textContent = pending;
                document.getElementById('completedOrders').textContent = completed;
            });
        }
    </script>
</body>
</html>
